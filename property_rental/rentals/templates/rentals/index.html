{% extends "rentals/layout.html" %}
{% load static %}

{% block title %}Property rental - Home{% endblock title %}

{% block content %}

    <div class="container-fluid pt-3">
        <!-- First Row -->
        <div class="row mb-4">
            {% for card in dashboard_card_props %}
                <div class="col-md-3">
                    {% include "rentals/snippets/dashboard_card.html" with logo_link=card.logoLink number=card.number number_text=card.number_text text=card.text %}
                </div>
            {% endfor %}
        </div>
        <!-- Second Row -->
        <div class="row">
            <div class="col-md-8">
                <!-- Cash Flow Chart -->
                <div class="card" id="homePageChartCard">
                    <div class="card-header">
                        Cash Flow Chart
                    </div>
                    <div class="card-body">
                        {% include "rentals/snippets/timeline-chart.html" with form_type="homePage" %}
                        <!-- Content of the Cash Flow Chart goes here -->
                        {% comment %} Third block will be bar chart with cash flow. The time width of the chart may be changed, as well as frequency of the data.  {% endcomment %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <!-- Payment Details -->
                <div class="card">
                    <div class="card-body p-0">
                        <h5 class="card-title fw-bold p-3">Payment schedule</h5>
                        <!-- Content of Payment Details goes here -->
                        {% comment %} The second block will show details on payments: x days of payment due, or payments made in time. Details on expenses listing all the required expenses with ticks or cross if expenses missed in certain months. {% endcomment %}
                        <div class="table-responsive">
                            {% include "rentals/payments_table.html" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block script %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>

    <script src="{% static 'rentals/chart.js' %}"></script>
    <script src="{% static 'rentals/index.js' %}"></script>
    {{ chart_data|json_script:"chartData" }}
    <script>
        // Chart initialisation}
        const chartDataScript = document.getElementById('chartData');
        const chartData = JSON.parse(chartDataScript.textContent);
        console.log(chartData)
        const ctxChart = document.getElementById("homePageBarChart");
        myChart = new Chart(ctxChart, {
            type: 'bar',
            data: chartData,
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                aspectRatio: 1|3,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        grace: '5%',
                        stacked: true,
                        title: {
                            display: true,
                            text: chartData.currency,
                        },
                        grid: {
                            display: false
                        }
                    },
                },
                layout: {
                    padding: 20
                },
                plugins: {
                    legend: {
                        display: false, // Hide the legend
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        offset: 5,
                        formatter: (value, context) => {
                            return value.toLocaleString("en-US", {
                                style: 'decimal', // or 'currency' or 'percent'
                                minimumFractionDigits: 0, // At least 2 decimal places
                                maximumFractionDigits: 0, // At most 2 decimal places
                                useGrouping: true,
                            });
                            /* SUM OF ALL CATEGORIES ON TOP OS STACKED BAR CHART
                            const dataArray = [];
                            context.chart.data.datasets.forEach((dataset) => {
                                if (dataset.data[context.dataIndex] != undefined) {
                                    // console.log(dataset.Index);
                                    if (context.datasetIndex > 0) {
                                        // Including conversion to integer from string
                                        dataArray.push(parseFloat(dataset.data[context.dataIndex]))
                                    }
                                }
                            });
                            // console.log(dataArray);
                            let sum = dataArray.reduce((a, b) => a + b, 0);
                            // sum = Math.round(sum * Math.pow(10, {{ number_of_digits }})) / Math.pow(10, {{ number_of_digits }});
                            sum = Math.round(sum * Math.pow(10, 1)) / Math.pow(10, 1);

                            // Keeping only one label with the last positive item
                            let labelIndex = dataArray.findLastIndex(value => value > 0);
                            if(context.datasetIndex === labelIndex) {
                                return sum.toLocaleString().replace(/,/g, '.');
                            } else if (context.datasetIndex === 0) {
                                return (context.dataset.data[context.dataIndex].toLocaleString())
                            } else {
                                return "";
                            }
                            */
                        }
                    }
                },
            },
        });
    </script>
{% endblock script %}